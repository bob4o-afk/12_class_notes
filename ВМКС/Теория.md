# Embedded System (Вградена система)

Устройство, което съдържа микроконтролер и е специализирано за извършване на специфични задачи. Пример за вградени системи включва: микровълнови фурни, роботи, автомобилни системи и др.

## Микроконтролер vs Микропроцесор

| **Критерий**            | **Микроконтролер (MCU)** | **Микропроцесор (CPU)** | **Обяснение**                                                                                   |
|-------------------------|--------------------------|--------------------------|-------------------------------------------------------------------------------------------------|
| **Изчислителен ресурс**  | Малък                    | Голям                    | MCU имат ограничени изчислителни възможности, докато CPU са проектирани за висока производителност.|
| **Брой транзистори**     | Малко                    | Много                    | MCU имат по-малко транзистори за по-ниска сложност и по-ниска консумация на енергия. CPU имат повече транзистори за по-голяма изчислителна мощност. |
| **Вградена RAM**         | Да                       | Не* (има cache)           | Микроконтролерите имат вградена RAM за основни операции, докато CPU обикновено използват външна RAM, допълнена с кеш. |
| **Вградена ROM**         | Да*                      | Не*                      | MCU имат вграден ROM за съхранение на инструкции, докато CPU разчитат на външна памет за съхранение на програмен код. |
| **Виртуална памет**      | Не*                      | Да                       | CPU поддържат виртуална памет, което им позволява да използват по-големи количества оперативна памет. |
| **Периферни модули**     | Много                    | Малко                    | MCU имат вградени периферни модули като таймери, ADC, и PWM, докато CPU използват външни устройства за тези функции. |

\* Има някои изключения

### Примери:

- **Микроконтролер (MCU):** Arduino, ESP32, STM32
- **Микропроцесор (CPU):** Intel Core i7, AMD Ryzen, ARM Cortex-A

## Как се изчислява колко бита е системата?

За да определим колко бита е дадена система, можем да разгледаме ширината на шината, използвана от процесора. Например:

- **8-битова система:** Микроконтролерът обработва 8 бита наведнъж (например AVR микроконтролери).
- **16-битова система:** Обработва 16 бита наведнъж (например MSP430).
- **32-битова система:** Обработва 32 бита наведнъж (например STM32).

## Тактова честота и изпълнение

- **Такт** - Това е една единична стъпка в работата на процесора, определяна от неговата тактова честота (честотата на осцилатора). Например 1 GHz означава 1 милиард такта в секунда.
- **АЛУ (Аритметико-логическо устройство):** То обработва зададените битове във всеки такт. Пример: 8-битова АЛУ може да обработва 8 бита за един такт.
  
  Например, ако процесорът е 8-битов и има тактова честота от 16 MHz, това означава, че той може да извършва 16 милиона операции за секунда, като всяка операция обработва 8 бита.

## Pipeline (Конвейер)

**Конвейерът** е техника за подобряване на производителността, като позволява едновременното изпълнение на различни стъпки от обработката на инструкциите. При тази техника инструкциите са разделени на няколко етапа (напр. извличане на инструкция, декодиране, изпълнение и запис), които се изпълняват успоредно. Това увеличава скоростта на изпълнение на програмата.

## Архитектури на памет

### Архитектура на фон Нойман

- **Общо описание:** Данните и инструкциите се съхраняват в една и съща памет. Процесорът извлича както данните, така и инструкциите от една и съща шина.
- **Предимства:** Определена простота в дизайна.
- **Недостатъци:** Възниква т.нар. "bottleneck" (тясно място), където процесорът може да бъде забавен, защото може да чете или инструкции, или данни в даден момент, но не и двете едновременно.

### Харвардска архитектура

- **Общо описание:** Паметта за инструкции и паметта за данни са отделни и се използват различни шини за достъп до тях.
- **Предимства:** Процесорът може да чете инструкции и данни едновременно, което подобрява производителността.
- **Недостатъци:** По-сложен дизайн и може да изисква повече памет.

### Пример за харвардска архитектура:
- **Микроконтролерът** STM32 използва харвардска архитектура, при която инструкциите и данните са отделени и се достъпват поотделно.


## Platformio
- https://docs.platformio.org/en/latest/integration/ide/vscode.html#ide-vscode-toolbar


## Presentation
- https://gitlab.com/tues-embedded/vmks-presentations


<br><br><br>




# Документация за Паметта и Работа с Указатели в C

## Описание

Тази документация обяснява основните концепции за паметови сегменти, битови операции и работата с указатели при 16-битова адресна шина. Целта е да предостави полезна и структурирана информация за начина, по който данните и кодът се съхраняват и манипулират в C.

## Съдържание
1. [Void Указател и Размер на Паметта](#void-указател-и-размер-на-паметта)
2. [Сегменти на Паметта](#сегменти-на-паметта)
   - [Data сегмент](#data-сегмент)
   - [Heap](#heap)
   - [Stack](#stack)
   - [BSS (Block Started by Symbol)](#bss-block-started-by-symbol)
3. [Архитектурни Зависимости](#архитектурни-зависимости)
4. [Адресно Пространство на RAM](#адресно-пространство-на-ram)
5. [Периферни Блокове и Тригер на Шмит](#периферни-блокове-и-тригер-на-шмит)
6. [Битови Операции и Използване на Битове](#битови-операции-и-използване-на-битове)
7. [Stack Canary](#stack-canary)

---

### Void Указател и Размер на Паметта

- **Void указател**: Указател с тип `void*` е указател, който не сочи към конкретен тип данни. Това позволява използването му за посочване към различни типове данни. Важно е обаче размерът на `void*` указателя да бъде достатъчен, за да покрие цялата ширина на адресната шина.
- **16-битова адресна шина**: Адресната шина е с размер 16 бита, което означава, че указателят също трябва да бъде поне 16-битов, за да адресира всички възможни адреси в паметта.

### Сегменти на Паметта

#### Data Сегмент
- **Data сегмент**: Съдържа глобални и статични локални променливи с ненулева начална стойност. Те се инициализират преди стартирането на програмата и остават в `data` сегмента по време на изпълнението.
- **Адреси**: Разполага се на най-ниските адреси в паметта.

#### Heap
- **Heap**: Динамично заделената памет в програма. Използва се за данни, чиито размер и време на създаване не са известни предварително, като такива заделени с `malloc` или `calloc`. Паметта в `heap` трябва ръчно да бъде освобождавана с `free`.

#### Stack
- **Stack**: Работен сегмент, използван за съхранение на временни данни, включително:
  1. **Локални променливи**: Променливи, дефинирани в дадена функция и достъпни само в нея.
  2. **Return стойности**: Ако стойностите на връщане са твърде големи за регистрите, те се съхраняват временно в стека.
  3. **Аргументи на функции**: Аргументите могат да се предават в стека, ако не могат да бъдат директно съхранени в регистрите.
  4. **Return адрес**: Адресът, на който трябва да се върне програмата след изпълнението на функцията.
  5. **Междинни стойности и регистри**: Междинни резултати, които трябва да се запазят при извикване на други функции.

> **Важно**: Стекът обикновено се разполага в "по-горните" адреси на паметта и работи надолу – когато се заделя нова памет за променливи, той се "спуска надолу", а когато се освобождава памет, се "издига нагоре".

#### BSS (Block Started by Symbol)
- **BSS** сегмент: Съдържа глобални и статични локални променливи с **нулева начална стойност**. BSS сегментът е специален, защото за него не се заделя реална физическа памет, а само се отбелязва необходимия размер в таблицата на символите.

---

### Архитектурни Зависимости

- **Константни променливи**: Зависи от архитектурата дали константите ще се съхраняват в `data`, `bss` сегмента или в отделен сегмент с права само за четене.
- **Макроси**: Когато се дефинират константи с `#define` (макроси), те може да не изискват реална памет в RAM, защото техните стойности се вграждат директно в кода.

---

### Адресно Пространство на RAM

В адресното пространство на RAM може да има и други памети, които се използват за различни цели:
- **EEPROM**: Нестабилна памет, подходяща за съхранение на малки количества данни, които трябва да се запазват дори при изключване на захранването.
- **Регистри на периферните устройства**: Често са достъпни в специфични адресни диапазони и служат за конфигурация и управление на външни модули.

![RAM схема](images/image.png)

---

### Периферни Блокове и Тригер на Шмит

- **GPIO** (General Purpose Input/Output): Периферен блок за вход/изход с общо предназначение. Може да бъде конфигуриран за четене или писане на данни чрез специфични регистри.
- **Тригер на Шмит**: Осигурява хистерезис за цифрови сигнали – когато входният сигнал премине горна гранична стойност, тригерът приема стойност "1" и остава такъв, докато сигналът не падне под долната граница.

![Тригер на Шмит](images/image-1.png)

#### Порт
- **Порт**: Група от пинове, които могат да се конфигурират като входни или изходни. Конфигурацията на даден пин се определя чрез специални битови операции.

---

### Битови Операции и Използване на Битове

Основни оператори за работа с битове:
- **И** (`&`) – побитово И.
- **ИЛИ** (`|`) – побитово ИЛИ.
- **НЕ** (`~`) – побитово НЕ.
- **XOR** (`^`) – побитово изключващо ИЛИ.

Операции за сдвижване:
- **Ляво сдвижване** (`<<`) – използва се за побитово изместване наляво.
- **Дясно сдвижване** (`>>`) – използва се за побитово изместване надясно.

Примери:
- **Вдигане на определен бит**:
  ```c
  a = a | (1 << 5);   // Вдигане на 5-ти бит във високо ниво
  a |= 1 << 5;
  ```
- **Нулиране на определен бит**:
  ```c
  a &= ~(1 << 5);      // Нулиране на 5-ти бит
  ```
- **Проверка на бит**:
  ```c
  if (a & (1 << 5)) {
      // Бит 5 е вдигнат
  }
  ```

---

### Stack Canary

- **Stack Canary**: Това е техника за защита на стека от презаписване, което може да възникне при препълване на буфера. Stack Canary добавя специални байтове (наречени "канарчета") преди адреса на върнатия указател. Ако канарчетата бъдат модифицирани (например при препълване на буфера), това сигнализира, че стекът е бил презаписан, което позволява на системата да прекрати програмата преди настъпване на по-сериозни последствия.